<!DOCTYPE html>
<html>
<head>
    <title>monte-carlo</title>

    <script type="text/javascript" src="/apps/2.0rc3/sdk.js"></script>

    <script type="text/javascript">
        Rally.onReady(function () {
                Ext.define('DataFetcher', {
  singleton: true,

  getChartData: function() {
    return Deft.Chain.pipeline([
      DataFetcher._getUnhydratedWorkItemRecords,
      DataFetcher._hydrateIterationValues
    ], this);
  },

  _getUnhydratedWorkItemRecords: function() {
    var deferred = Ext.create('Deft.Deferred');
    Ext.create('Rally.data.lookback.SnapshotStore', {
      limit: Infinity,
      fetch: ['FormattedID', 'Iteration', 'PlanEstimate', 'ScheduleState'],
      hydrate: ['ScheduleState'],
      filters: [{
        property: '__At',
        value: 'current'
      },{
        property: '_TypeHierarchy',
        operator: 'in',
        value: ['Defect', 'HierarchicalRequirement']
      },{
        property: '_ItemHierarchy',
        value: this.piOID
      },{
        property: 'PlanEstimate',
        operator: '>',
        value: 0
      },{
        property: 'Children',
        value: null
      }]
    }).load({
      params : {
        removeUnauthorizedSnapshots: true
      },
      callback: function(workItemRecords, operation, success) {
        if (success && workItemRecords.length) {
          deferred.resolve(workItemRecords);
        } else {
          deferred.reject('No artifacts found.');
        }
      }
    });
    return deferred.promise;
  },

  _hydrateIterationValues: function(workItemRecords) {
    var deferred = Ext.create('Deft.Deferred');

    var iterationOIDs = _.filter(_.unique(_.map(workItemRecords, function(workItemRecord) {
      return workItemRecord.get('Iteration');
    })), function(OID) {
      return OID;
    });

    var iterationFilter = Rally.data.QueryFilter.or(_.map(iterationOIDs, function(OID) {
      return {
        property: 'ObjectID',
        value: OID
      };
    }));

    Ext.create('Rally.data.WsapiDataStore', {
      model: 'Iteration',
      fetch: ['Name', 'StartDate', 'EndDate'],
      filters: iterationFilter
    }).load().then(function(iterationRecords) {
      var iterationRecordsTwo = iterationRecords;

      var iterationNameMap = _.zipObject(_.map(iterationRecords, function(iterationRecord) {
        return iterationRecord.get('ObjectID');
      }), _.map(iterationRecords, function(iterationRecord) {
        return iterationRecord.get('Name');
      }));

      var iterationDataMap = _.zipObject(_.map(iterationRecords, function(iterationRecord) {
        return iterationRecord.get('Name');
      }), _.map(iterationRecords, function(iterationRecord) {
        return {
          Name: iterationRecord.get('Name'),
          StartDate: iterationRecord.get('StartDate'),
          EndDate: iterationRecord.get('EndDate'),
          WorkItems: []
        };
      }));

      iterationDataMap.Backlog = {
        Name: 'Backlog',
        WorkItems: []
      };

      _.each(workItemRecords, function(workItemRecord) {
        if (iterationDataMap[iterationNameMap[workItemRecord.get('Iteration')]]) {
          iterationDataMap[iterationNameMap[workItemRecord.get('Iteration')]].WorkItems.push(workItemRecord);
        } else {
          iterationDataMap.Backlog.WorkItems.push(workItemRecord);
        }
      });

      deferred.resolve(_.values(iterationDataMap));
    });

    return deferred.promise;
  }
});
                Ext.define('DataAggregator', {
  singleton: true,

  parseChartData: function(chartData) {
    return DataAggregator._calculateIterationVelocities(chartData)
      .then(DataAggregator._projectFutureIterations);
  },

  _calculateIterationVelocities: function(chartData) {
    var deferred = Ext.create('Deft.Deferred');

    Deft.Promise.all(_.map(['HierarchicalRequirement', 'Defect'], function(modelName) {
      return function() {
        var deferred = Ext.create('Deft.Deferred');
        Rally.data.ModelFactory.getModel({
          type: modelName,
          success: function(model) {
            model.getField('ScheduleState').getAllowedValueStore().load({
              callback: function(stateRecords, operation, success) {
                deferred.resolve(stateRecords[stateRecords.length - 1].get('StringValue'));
              }
            });
          }
        });
        return deferred.promise;
      }();
    })).then({
      success: function(finalStateNames) {
        chartData = _.sortBy(chartData, 'StartDate');

        _.each(chartData, function(iterationDetail, index) {
          if (iterationDetail.Name !== 'Backlog') {
            iterationDetail.Velocity = _.reduce(iterationDetail.WorkItems, function(sum, workItemRecord) {
              return sum + (_.contains(finalStateNames, workItemRecord.get('ScheduleState')) ? workItemRecord.get('PlanEstimate') : 0);
            }, 0);

            iterationDetail.AccumulatedVelocity = _.reduce(chartData, function(sum, iterationDetail) {
              return sum + (iterationDetail.Velocity || 0);
            }, 0);
          }
        });

        deferred.resolve(chartData);
      }
    });

    return deferred.promise;
  },

  _projectFutureIterations: function(chartData) {
    return chartData;
  }
});
                Ext.define('ChartRenderer', {
  singleton: true,

  render: function(chartData) {
    var ranges = [
      [1246406400000, 14.3, 27.7],
      [1246492800000, 14.5, 27.8],
      [1246579200000, 15.5, 29.6],
      [1246665600000, 16.7, 30.7],
      [1246752000000, 16.5, 25.0],
      [1246838400000, 17.8, 25.7],
      [1246924800000, 13.5, 24.8],
      [1247011200000, 10.5, 21.4],
      [1247097600000, 9.2, 23.8],
      [1247184000000, 11.6, 21.8],
      [1247270400000, 10.7, 23.7],
      [1247356800000, 11.0, 23.3],
      [1247443200000, 11.6, 23.7],
      [1247529600000, 11.8, 20.7],
      [1247616000000, 12.6, 22.4],
      [1247702400000, 13.6, 19.6],
      [1247788800000, 11.4, 22.6],
      [1247875200000, 13.2, 25.0],
      [1247961600000, 14.2, 21.6],
      [1248048000000, 13.1, 17.1],
      [1248134400000, 12.2, 15.5],
      [1248220800000, 12.0, 20.8],
      [1248307200000, 12.0, 17.1],
      [1248393600000, 12.7, 18.3],
      [1248480000000, 12.4, 19.4],
      [1248566400000, 12.6, 19.9],
      [1248652800000, 11.9, 20.2],
      [1248739200000, 11.0, 19.3],
      [1248825600000, 10.8, 17.8],
      [1248912000000, 11.8, 18.5],
      [1248998400000, 10.8, 16.1]
    ];

    var averages = [
      [1246406400000, 21.5],
      [1246492800000, 22.1],
      [1246579200000, 23],
      [1246665600000, 23.8],
      [1246752000000, 21.4],
      [1246838400000, 21.3],
      [1246924800000, 18.3],
      [1247011200000, 15.4],
      [1247097600000, 16.4],
      [1247184000000, 17.7],
      [1247270400000, 17.5],
      [1247356800000, 17.6],
      [1247443200000, 17.7],
      [1247529600000, 16.8],
      [1247616000000, 17.7],
      [1247702400000, 16.3],
      [1247788800000, 17.8],
      [1247875200000, 18.1],
      [1247961600000, 17.2],
      [1248048000000, 14.4],
      [1248134400000, 13.7],
      [1248220800000, 15.7],
      [1248307200000, 14.6],
      [1248393600000, 15.3],
      [1248480000000, 15.3],
      [1248566400000, 15.8],
      [1248652800000, 15.2],
      [1248739200000, 14.8],
      [1248825600000, 14.4],
      [1248912000000, 15],
      [1248998400000, 13.6]
    ];

    Ext.getCmp('chartContainer').removeAll();
    Ext.getCmp('chartContainer').add({
      xtype: 'rallychart',
      id: 'chart',
      chartConfig: {
        chart: {
          type: '',
          height: Ext.getCmp('chartContainer').getHeight()
        },
        reflow: false,
        title: {
          text: 'July temperatures'
        },
        xAxis: {
          type: 'datetime'
        },
        yAxis: {
          title: {
            text: null
          }
        },
        tooltip: {
          crosshairs: true,
          shared: true,
          valueSuffix: 'Â°C'
        },
        legend: {}
      },
      chartData: {
        series: [{
          name: 'Temperature',
          data: averages,
          zIndex: 1,
          marker: {
            fillColor: 'white',
            lineWidth: 2
          }
        },{
          name: 'Range',
          data: ranges,
          type: 'arearange',
          lineWidth: 0,
          linkedTo: ':previous',
          fillOpacity: 0.3,
          zIndex: 0
        }]
      }
    });
  }
});
                Ext.define('CustomApp', {
    extend: 'Rally.app.App',
    componentCls: 'app',

    layout: 'border',

    launch: function() {
      this._setupUI();

      this.piOID = 19728385560; //Will be set by "_changePortfolioItem"

      Deft.Chain.pipeline([
        DataFetcher.getChartData,
        DataAggregator.parseChartData
      ], this).then({
        success: ChartRenderer.render
        // failure: this._showErrorMsg
      });
    },

    _showErrorMsg: function(err) {
      console.log('error', err);
    },

    _setupUI: function() {
      this.add([{
        region: 'north',
        xtype: 'container',
        layout: 'hbox',
        items: [{
          xtype: 'component',
          flex: 1
        },{
          xtype: 'rallybutton',
          text: '<span class="icon-gear icon-large"></span>',
          margin: '3 3 3 3',
          arrowCls: '',
          menu: {
            xtype: 'menu',
            items: [{
              text: 'Change Portfolio Item',
              listeners: {
                click: this._changePortfolioItem,
                scope: this
              }
            }]
          }
        }]
      },{
        region: 'center',
        xtype: 'container',
        id: 'chartContainer',
        style: {
          background: 'red'
        }
      }]);
    },

    _changePortfolioItem: function() {
      Deft.Chain.pipeline([
        this._selectNewPortfolioItem,
        this._saveSelectedPortfolioItem
      ], this).then({
        success: function() {
          Rally.ui.notify.Notifier.show({
            message  : 'Settings saved successfully.',
            duration : 3000
          });
        },
        failure: function(err) {
          if (err) {
            Rally.ui.notify.Notifier.showError({
              message: err,
              duration: 5000
            });
          }
        }
      });
    },

    _selectNewPortfolioItem: function() {
      var deferred = Ext.create('Deft.Deferred');
      Ext.create('Rally.ui.dialog.SolrArtifactChooserDialog', {
        artifactTypes: ['PortfolioItem'],
        autoShow: true,
        closable: false,
        height: 500,
        title: 'Choose Portfolio Item',
        storeConfig: {
          sorters: [{
            property: 'FormattedID',
            direction: 'ASC'
          }]
        },
        listeners: {
          artifactchosen: function(chooser, selectedRecord) {
            chooser.recordSelected = true;
            deferred.resolve(selectedRecord);
          },
          close: function(chooser) {
            if (!chooser.recordSelected) {
              deferred.reject();
            }
          },
          scope: this
        }
      });
      return deferred.promise;
    },

    _saveSelectedPortfolioItem: function(selectedRecord) {
      var deferred = Ext.create('Deft.Deferred');
      deferred.reject('Not availible yet...');
      // Rally.data.PreferenceManager.update({
      //   filterByUser: true,
      //   settings: {
      //     'monte-carlo-portfolio-item-oid': selectedRecord.get('ObjectID')
      //   }
      // });
      return deferred.promise;
    },

    _getSavedPortfolioItem: function() {
      var deferred = Ext.create('Deft.Deferred');
      deferred.resolve(19728385560); //I3180
      return deferred.promise;


      // Rally.data.PreferenceManager.load({
      //   filterByUser: true,
      //   success: function(prefs) {
      //       deferred.resolve(Ext.JSON.decode(prefs.selectedFeatureOIDs));
      //   },
      //   scope: this
      // });
    }
});


            Rally.launchApp('CustomApp', {
                name:"monte-carlo",
	            parentRepos:""
            });

        });
    </script>


    <style type="text/css">
        
    </style>
</head>
<body>
</body>
</html>
