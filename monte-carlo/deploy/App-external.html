<!DOCTYPE html>
<html>
<head>
    <title>monte-carlo</title>

    <script type="text/javascript" src="https://rally1.rallydev.com/apps/2.0rc3/sdk.js"></script>

    <script type="text/javascript">
        Rally.onReady(function () {
                Ext.define("DataFetcher",{singleton:!0,getChartData:function(){return Deft.Chain.pipeline([DataFetcher._getUnhydratedWorkItemRecords,DataFetcher._hydrateIterationValues],this)},_getUnhydratedWorkItemRecords:function(){var deferred=Ext.create("Deft.Deferred");return Ext.create("Rally.data.lookback.SnapshotStore",{limit:1/0,fetch:["FormattedID","Iteration","PlanEstimate","ScheduleState"],hydrate:["ScheduleState"],filters:[{property:"__At",value:"current"},{property:"_TypeHierarchy",operator:"in",value:["Defect","HierarchicalRequirement"]},{property:"_ItemHierarchy",value:this.piOID},{property:"PlanEstimate",operator:">",value:0},{property:"Children",value:null}]}).load({params:{removeUnauthorizedSnapshots:!0},callback:function(workItemRecords,operation,success){success&&workItemRecords.length?deferred.resolve(workItemRecords):deferred.reject("No artifacts found.")}}),deferred.promise},_hydrateIterationValues:function(workItemRecords){var deferred=Ext.create("Deft.Deferred"),iterationOIDs=_.filter(_.unique(_.map(workItemRecords,function(workItemRecord){return workItemRecord.get("Iteration")})),function(OID){return OID}),iterationFilter=Rally.data.QueryFilter.or(_.map(iterationOIDs,function(OID){return{property:"ObjectID",value:OID}}));return Ext.create("Rally.data.WsapiDataStore",{model:"Iteration",fetch:["Name","StartDate","EndDate"],filters:iterationFilter}).load().then(function(iterationRecords){var iterationRecordsTwo=iterationRecords,iterationNameMap=_.zipObject(_.map(iterationRecords,function(iterationRecord){return iterationRecord.get("ObjectID")}),_.map(iterationRecords,function(iterationRecord){return iterationRecord.get("Name")})),iterationDataMap=_.zipObject(_.map(iterationRecords,function(iterationRecord){return iterationRecord.get("Name")}),_.map(iterationRecords,function(iterationRecord){return{Name:iterationRecord.get("Name"),StartDate:iterationRecord.get("StartDate"),EndDate:iterationRecord.get("EndDate"),WorkItems:[]}}));iterationDataMap.Backlog={Name:"Backlog",WorkItems:[]},_.each(workItemRecords,function(workItemRecord){iterationDataMap[iterationNameMap[workItemRecord.get("Iteration")]]?iterationDataMap[iterationNameMap[workItemRecord.get("Iteration")]].WorkItems.push(workItemRecord):iterationDataMap.Backlog.WorkItems.push(workItemRecord)}),deferred.resolve(_.values(iterationDataMap))}),deferred.promise}});
                Ext.define("DataAggregator",{singleton:!0,parseChartData:function(chartData){return DataAggregator._calculateIterationVelocities(chartData).then(DataAggregator._projectFutureIterations)},_calculateIterationVelocities:function(chartData){var deferred=Ext.create("Deft.Deferred");return Deft.Promise.all(_.map(["HierarchicalRequirement","Defect"],function(modelName){return function(){var deferred=Ext.create("Deft.Deferred");return Rally.data.ModelFactory.getModel({type:modelName,success:function(model){model.getField("ScheduleState").getAllowedValueStore().load({callback:function(stateRecords,operation,success){deferred.resolve(stateRecords[stateRecords.length-1].get("StringValue"))}})}}),deferred.promise}()})).then({success:function(finalStateNames){chartData=_.sortBy(chartData,"StartDate"),_.each(chartData,function(iterationDetail,index){"Backlog"!==iterationDetail.Name&&(iterationDetail.Velocity=_.reduce(iterationDetail.WorkItems,function(sum,workItemRecord){return sum+(_.contains(finalStateNames,workItemRecord.get("ScheduleState"))?workItemRecord.get("PlanEstimate"):0)},0),iterationDetail.AccumulatedVelocity=_.reduce(chartData,function(sum,iterationDetail){return sum+(iterationDetail.Velocity||0)},0))}),deferred.resolve(chartData)}}),deferred.promise},_projectFutureIterations:function(chartData){return chartData}});
                Ext.define("ChartRenderer",{singleton:!0,render:function(chartData){var ranges=[[12464064e5,14.3,27.7],[12464928e5,14.5,27.8],[12465792e5,15.5,29.6],[12466656e5,16.7,30.7],[1246752e6,16.5,25],[12468384e5,17.8,25.7],[12469248e5,13.5,24.8],[12470112e5,10.5,21.4],[12470976e5,9.2,23.8],[1247184e6,11.6,21.8],[12472704e5,10.7,23.7],[12473568e5,11,23.3],[12474432e5,11.6,23.7],[12475296e5,11.8,20.7],[1247616e6,12.6,22.4],[12477024e5,13.6,19.6],[12477888e5,11.4,22.6],[12478752e5,13.2,25],[12479616e5,14.2,21.6],[1248048e6,13.1,17.1],[12481344e5,12.2,15.5],[12482208e5,12,20.8],[12483072e5,12,17.1],[12483936e5,12.7,18.3],[124848e7,12.4,19.4],[12485664e5,12.6,19.9],[12486528e5,11.9,20.2],[12487392e5,11,19.3],[12488256e5,10.8,17.8],[1248912e6,11.8,18.5],[12489984e5,10.8,16.1]],averages=[[12464064e5,21.5],[12464928e5,22.1],[12465792e5,23],[12466656e5,23.8],[1246752e6,21.4],[12468384e5,21.3],[12469248e5,18.3],[12470112e5,15.4],[12470976e5,16.4],[1247184e6,17.7],[12472704e5,17.5],[12473568e5,17.6],[12474432e5,17.7],[12475296e5,16.8],[1247616e6,17.7],[12477024e5,16.3],[12477888e5,17.8],[12478752e5,18.1],[12479616e5,17.2],[1248048e6,14.4],[12481344e5,13.7],[12482208e5,15.7],[12483072e5,14.6],[12483936e5,15.3],[124848e7,15.3],[12485664e5,15.8],[12486528e5,15.2],[12487392e5,14.8],[12488256e5,14.4],[1248912e6,15],[12489984e5,13.6]];Ext.getCmp("chartContainer").removeAll(),Ext.getCmp("chartContainer").add({xtype:"rallychart",id:"chart",chartConfig:{chart:{type:"",height:Ext.getCmp("chartContainer").getHeight()},reflow:!1,title:{text:"July temperatures"},xAxis:{type:"datetime"},yAxis:{title:{text:null}},tooltip:{crosshairs:!0,shared:!0,valueSuffix:"Â°C"},legend:{}},chartData:{series:[{name:"Temperature",data:averages,zIndex:1,marker:{fillColor:"white",lineWidth:2}},{name:"Range",data:ranges,type:"arearange",lineWidth:0,linkedTo:":previous",fillOpacity:.3,zIndex:0}]}})}});
                Ext.define("CustomApp",{extend:"Rally.app.App",componentCls:"app",layout:"border",launch:function(){this._setupUI(),this.piOID=19728385560,Deft.Chain.pipeline([DataFetcher.getChartData,DataAggregator.parseChartData],this).then({success:ChartRenderer.render})},_showErrorMsg:function(err){console.log("error",err)},_setupUI:function(){this.add([{region:"north",xtype:"container",layout:"hbox",items:[{xtype:"component",flex:1},{xtype:"rallybutton",text:'<span class="icon-gear icon-large"></span>',margin:"3 3 3 3",arrowCls:"",menu:{xtype:"menu",items:[{text:"Change Portfolio Item",listeners:{click:this._changePortfolioItem,scope:this}}]}}]},{region:"center",xtype:"container",id:"chartContainer",style:{background:"red"}}])},_changePortfolioItem:function(){Deft.Chain.pipeline([this._selectNewPortfolioItem,this._saveSelectedPortfolioItem],this).then({success:function(){Rally.ui.notify.Notifier.show({message:"Settings saved successfully.",duration:3e3})},failure:function(err){err&&Rally.ui.notify.Notifier.showError({message:err,duration:5e3})}})},_selectNewPortfolioItem:function(){var deferred=Ext.create("Deft.Deferred");return Ext.create("Rally.ui.dialog.SolrArtifactChooserDialog",{artifactTypes:["PortfolioItem"],autoShow:!0,closable:!1,height:500,title:"Choose Portfolio Item",storeConfig:{sorters:[{property:"FormattedID",direction:"ASC"}]},listeners:{artifactchosen:function(chooser,selectedRecord){chooser.recordSelected=!0,deferred.resolve(selectedRecord)},close:function(chooser){chooser.recordSelected||deferred.reject()},scope:this}}),deferred.promise},_saveSelectedPortfolioItem:function(selectedRecord){var deferred=Ext.create("Deft.Deferred");return deferred.reject("Not availible yet..."),deferred.promise},_getSavedPortfolioItem:function(){var deferred=Ext.create("Deft.Deferred");return deferred.resolve(19728385560),deferred.promise}});

            Rally.launchApp('CustomApp', {
                name:"monte-carlo",
	            parentRepos:""
            });

        });
    </script>


    <style type="text/css">
        
    </style>
</head>
<body>
</body>
</html>
